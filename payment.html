<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TANGGO HERVAX | Secure Payment Gateway</title>
    <link rel="icon" type="image/png" href="tanggo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --brand-red: #980002;
            --brand-dark: #0f0f0f;
            --success-green: #2ecc71;
            --undpay-blue: #0052ff;
            --border-color: #e5e7eb;
            --bg-light: #f8fafc;
            --glass-header-footer: rgba(255, 255, 255, 0.7);
            --glass-blur: blur(20px);
        }

        body {
            margin: 0; font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-light); color: #1e293b; min-height: 100vh; display: flex; flex-direction: column;
        }

        /* --- GLASS HEADER & FOOTER --- */
        .navbar, footer {
            background: var(--glass-header-footer) !important;
            backdrop-filter: var(--glass-blur) saturate(180%) !important;
            -webkit-backdrop-filter: var(--glass-blur) saturate(180%) !important;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            color: #1a1a1a !important;
        }

        .navbar { 
            padding: 12px 8%; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
        }

        footer { 
            padding: 20px; 
            text-align: center; 
            font-size: 12px; 
            margin-top: auto; 
            border-top: 1px solid rgba(0, 0, 0, 0.1); 
            color: #64748b !important;
        }

        .gateway-wrapper {
            max-width: 1100px;
            margin: 40px auto;
            width: 95%;
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 30px;
            flex: 1;
        }

        @media (max-width: 900px) {
            .gateway-wrapper { grid-template-columns: 1fr; margin: 20px auto; }
        }

        .payment-main {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            padding: 40px;
            min-height: 550px;
            position: relative;
        }

        .order-sidebar {
            background: #fff;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            padding: 30px;
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .bank-partner-logo {
            height: 40px;
            width: 120px;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #94a3b8;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .card-preview {
            background: linear-gradient(135deg, #0f172a, #334155);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            position: relative;
            height: 180px;
            display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 15px 30px rgba(15, 23, 42, 0.2);
        }

        .method-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 25px 0; }
        .method-btn { 
            border: 2px solid #f1f5f9; padding: 15px; border-radius: 12px; 
            cursor: pointer; text-align: center; transition: all 0.2s; background: #fff;
            display: flex; flex-direction: column; align-items: center; gap: 8px; font-weight: 600; font-size: 13px;
            position: relative;
        }
        .method-btn i { font-size: 20px; color: #64748b; }
        .method-btn img { height: 24px; width: auto; object-fit: contain; }
        
        .method-btn:hover { border-color: var(--brand-red); background: #fffcfc; }
        .method-btn.undpay-btn:hover { border-color: var(--undpay-blue); background: #f0f7ff; }
        
        .method-btn.active-method { border-color: var(--undpay-blue); background: #f0f7ff; }

        .payment-screen { display: none; }
        .active-screen { display: block; animation: slideIn 0.4s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(15px); } to { opacity: 1; transform: translateX(0); } }

        .input-group { margin-bottom: 18px; }
        .input-group label { display: block; font-size: 12px; color: #475569; margin-bottom: 6px; font-weight: 600; }
        input, select { 
            width: 100%; padding: 14px; border: 1.5px solid #e2e8f0; border-radius: 10px; 
            font-size: 14px; box-sizing: border-box; outline: none; transition: 0.2s;
        }
        input:focus { border-color: var(--brand-red); box-shadow: 0 0 0 3px rgba(152, 0, 2, 0.1); }
        .undpay-focus:focus { border-color: var(--undpay-blue) !important; box-shadow: 0 0 0 3px rgba(0, 82, 255, 0.1) !important; }

        .otp-container { display: flex; gap: 10px; justify-content: center; margin: 25px 0; width: 100%; }
        .otp-box {
            width: 50px; height: 60px; text-align: center; font-size: 24px; font-weight: 800;
            border: 2px solid #e2e8f0; border-radius: 10px; background: #fff; transition: all 0.2s;
            box-sizing: border-box;
        }
        .otp-box:focus { border-color: var(--brand-red); outline: none; box-shadow: 0 0 0 3px rgba(152, 0, 2, 0.1); }
        .otp-box::-webkit-outer-spin-button, .otp-box::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        .bank-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; max-height: 280px; overflow-y: auto; padding-right: 5px; }
        .bank-item {
            display: flex; align-items: center; justify-content: space-between; padding: 12px 15px;
            border: 1.5px solid #e2e8f0; border-radius: 10px; cursor: pointer; transition: 0.2s;
        }
        .bank-item img { height: 22px; width: auto; object-fit: contain; }
        .bank-item span { font-size: 14px; font-weight: 600; }
        .bank-item:hover { border-color: var(--brand-red); background: #fffcfc; }
        .bank-selected { border-color: var(--brand-red); background: #fffcfc; border-width: 2px; }
        .hidden-bank { display: none; }

        .btn-pay { 
            background: var(--brand-dark); color: white; width: 100%; padding: 18px; 
            border: none; border-radius: 10px; font-weight: 700; cursor: pointer; 
            text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; 
        }
        .btn-pay:hover:not(:disabled) { background: var(--brand-red); transform: translateY(-2px); }
        .btn-pay:disabled { background: #cbd5e1; cursor: not-allowed; }
        .btn-undpay { background: var(--undpay-blue) !important; }
        .btn-undpay:hover:not(:disabled) { transform: translateY(-2px); opacity: 0.9; }

        .price-tag { font-size: 2.2rem; color: var(--brand-dark); font-weight: 800; margin: 15px 0; }
        
        .processing-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal-window { background: #fff; width: 90%; max-width: 450px; padding: 35px; border-radius: 20px; text-align: center; }
        
        .receipt-container { 
            background: white; color: #1e293b; width: 90%; max-width: 420px; max-height: 85vh;
            padding: 0; border-radius: 16px; font-family: 'Inter', sans-serif; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); overflow-y: auto; border: none; scrollbar-width: none;
        }
        .receipt-container::-webkit-scrollbar { display: none; }
        
        .installment-box { border: 1.5px solid #e2e8f0; padding: 15px; border-radius: 10px; margin-bottom: 12px; cursor: pointer; display: flex; justify-content: space-between; transition: 0.2s; }
        .inst-active { border-color: var(--brand-red); background: #fffcfc; border-width: 2px; }
        .loader { border: 4px solid rgba(255,255,255,0.2); border-left-color: #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .back-btn { cursor: pointer; color: #64748b; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 5px; margin-bottom: 25px; }

        .success-circle { 
            width: 70px; height: 70px; background: #dcfce7; color: var(--success-green); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-size: 35px; margin: 0 auto 15px; border: 2px solid var(--success-green);
        }
        .success-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #e2e8f0; padding: 10px 0; font-size: 13px; }
        .success-row:last-child { border: none; }
        .success-label { color: #64748b; font-weight: 500; }
        .success-val { font-weight: 700; color: #0f172a; text-align: right; }

        .redirect-box { 
            position: fixed; inset: 0; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); 
            z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }

        /* --- UNDPAY SPECIAL STYLES --- */
        .undpay-badge { background: #e0eaff; color: var(--undpay-blue); padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 800; letter-spacing: 0.5px; }
        .scan-line { width: 100%; height: 2px; background: var(--undpay-blue); position: absolute; top: 0; left: 0; box-shadow: 0 0 15px var(--undpay-blue); animation: scanMove 2s infinite linear; display: none;}
        @keyframes scanMove { 0% { top: 0; } 100% { top: 100%; } }
        
        .discount-badge { font-size: 10px; background: #dcfce7; color: #15803d; padding: 2px 6px; border-radius: 4px; font-weight: 700; }
        .preferred-tag { position: absolute; top: -10px; right: -5px; background: #2ecc71; color: white; padding: 2px 8px; border-radius: 4px; font-size: 9px; font-weight: 900; box-shadow: 0 4px 6px rgba(46, 204, 113, 0.2); }

        /* --- NEW UNDPAYLATER ENHANCEMENTS --- */
        .asset-backed-badge { background: #f0fdf4; color: #166534; font-size: 9px; padding: 2px 6px; border-radius: 4px; border: 1px solid #bbf7d0; font-weight: 700; }
        .roadmap-container { margin: 15px 0; padding: 15px; background: #fafafa; border-radius: 10px; border: 1px solid #eee; }
        .roadmap-step { display: flex; gap: 12px; margin-bottom: 10px; position: relative; }
        .roadmap-step:not(:last-child)::after { content: ''; position: absolute; left: 4.5px; top: 12px; height: 100%; width: 1px; background: #e2e8f0; }
        .roadmap-dot { width: 10px; height: 10px; background: var(--undpay-blue); border-radius: 50%; margin-top: 4px; z-index: 1; }
        .roadmap-info { font-size: 11px; display: flex; justify-content: space-between; width: 100%; }
        .roadmap-date { color: #64748b; }
        .roadmap-amt { font-weight: 700; color: #0f172a; }
        #scan-status-text { font-size: 10px; color: var(--undpay-blue); font-weight: 700; margin-top: 10px; display: none; text-transform: uppercase; text-align: center; }
    </style>
</head>
<body>

    <div class="processing-overlay" id="startup-reminder" style="display: flex;">
        <div class="modal-window">
            <i class="fas fa-shield-check" style="font-size: 45px; color: var(--success-green); margin-bottom: 15px;"></i>
            <h3>Secure Gateway Ready</h3>
            <p style="color: #64748b; font-size: 14px; margin-bottom: 25px;">
                You are now in a 256-bit encrypted session. To ensure a smooth transaction, we recommend <strong>not refreshing</strong> or closing this window until your receipt is generated.
            </p>
            <button class="btn-pay" onclick="closePopup('startup-reminder')">PROCEED SECURELY</button>
        </div>
    </div>

    <div class="processing-overlay" id="und-popup-1">
        <div class="modal-window">
            <i class="fas fa-info-circle" style="font-size: 45px; color: var(--undpay-blue); margin-bottom: 15px;"></i>
            <h3>UNDPay Premium Note</h3>
            <p style="color: #64748b; font-size: 14px; margin-bottom: 25px;">You have selected the most secure payment method. Your personal data is protected by the UND-Vault system and never shared with the merchant.</p>
            <button class="btn-pay btn-undpay" onclick="closePopup('und-popup-1'); document.getElementById('und-popup-2').style.display='flex'">I UNDERSTOOD</button>
        </div>
    </div>

    <div class="processing-overlay" id="und-popup-2">
        <div class="modal-window">
            <i class="fas fa-exclamation-triangle" style="font-size: 45px; color: #f59e0b; margin-bottom: 15px;"></i>
            <h3>Security Reminder</h3>
            <p style="color: #64748b; font-size: 14px; margin-bottom: 25px;">Please ensure your UND-Authenticator app is open. You will be required to provide a temporary Hardware Token in the next step.</p>
            <button class="btn-pay btn-undpay" onclick="closePopup('und-popup-2'); handleUNDSecurityFlow()">I UNDERSTOOD</button>
        </div>
    </div>

    <div class="processing-overlay" id="und-popup-3">
        <div class="modal-window">
            <i class="fas fa-bolt" style="font-size: 45px; color: var(--success-green); margin-bottom: 15px;"></i>
            <h3>Discount Applied</h3>
            <p style="color: #64748b; font-size: 14px; margin-bottom: 25px;">Congratulations! By using UNDPay, a <strong>4% VIP Discount</strong> has been applied to your final total automatically.</p>
            <button class="btn-pay btn-undpay" onclick="closePopup('und-popup-3'); proceedToUNDMethod()">I UNDERSTOOD</button>
        </div>
    </div>

    <div class="processing-overlay" id="alert-system">
        <div class="modal-window">
            <i class="fas fa-exclamation-circle" style="font-size: 45px; color: var(--brand-red); margin-bottom: 15px;"></i>
            <h3 id="alert-title">Security Alert</h3>
            <p id="alert-msg" style="color: #64748b; font-size: 14px; margin-bottom: 25px;"></p>
            <button class="btn-pay" onclick="closePopup('alert-system')">ACKNOWLEDGE</button>
        </div>
    </div>

    <div class="processing-overlay" id="loader">
        <div class="loader" id="spinner-circle"></div>
        <h3 id="loader-text" style="color:white; letter-spacing: 2px; font-size: 14px;">SECURE CONNECTION...</h3>
    </div>

    <div class="processing-overlay" id="confirm-modal">
        <div class="modal-window">
            <h3 style="margin:0 0 20px 0;"><i class="fas fa-shield-alt" style="color:var(--success-green)"></i> Secure Checkout</h3>
            <div id="dynamic-details-area" style="text-align: left; background: #f8fafc; padding: 15px; border-radius: 10px; font-size: 13px; margin-bottom: 20px;"></div>
            <button class="btn-pay" onclick="checkAgreementRequirement()">VERIFY & PAY</button>
            <button style="background:none; border:none; color:#64748b; margin-top:15px; cursor:pointer;" onclick="closePopup('confirm-modal')">Cancel Transaction</button>
        </div>
    </div>

    <div class="processing-overlay" id="agreement-modal">
        <div class="modal-window">
            <h3>Credit Agreement</h3>
            <div style="height: 180px; overflow-y: auto; font-size: 12px; border: 1px solid #e2e8f0; padding: 15px; background: #f8fafc; color: #475569; text-align: left; margin-bottom: 15px;">
                <strong>1. INSTALLMENT TERMS</strong><br>
                By proceeding, you agree to pay the monthly installments as scheduled.<br><br>
                <strong>2. AUTOMATIC DEBIT</strong><br>
                You authorize Tanggo Hervax to charge your linked account.<br><br>
                <strong>3. LATE FEES</strong><br>
                A 1.5% late fee applies to overdue balances.
            </div>
            <label style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px; font-size: 12px; cursor: pointer; text-align: left;">
                <input type="checkbox" id="final-agreement-check" onchange="document.getElementById('agree-btn').disabled = !this.checked" style="width: auto;"> 
                I agree to the Credit Terms and Conditions.
            </label>
            <button class="btn-pay" id="agree-btn" disabled onclick="startMultiStepProcess()">SIGN & AUTHORIZE</button>
        </div>
    </div>

    <div class="processing-overlay" id="verification-modal">
        <div class="modal-window">
            <h3 id="verification-title">3D Secure Verification</h3>
            <p id="verification-desc" style="font-size: 13px; color: #64748b;">Enter the 6-digit code sent to your phone.</p>
            
            <div class="otp-container" id="otp-inputs">
                <input type="number" class="otp-box" oninput="moveToNext(this, 0)" onkeydown="moveBack(event, 0)">
                <input type="number" class="otp-box" oninput="moveToNext(this, 1)" onkeydown="moveBack(event, 1)">
                <input type="number" class="otp-box" oninput="moveToNext(this, 2)" onkeydown="moveBack(event, 2)">
                <input type="number" class="otp-box" oninput="moveToNext(this, 3)" onkeydown="moveBack(event, 3)">
                <input type="number" class="otp-box" oninput="moveToNext(this, 4)" onkeydown="moveBack(event, 4)">
                <input type="number" class="otp-box" oninput="moveToNext(this, 5)" onkeydown="moveBack(event, 5)">
            </div>

            <button class="btn-pay" id="final-auth-btn" onclick="finalAuthorize()">CONFIRM PAYMENT</button>
            <p style="font-size: 11px; margin-top: 20px; color: #94a3b8;">Ref: <span id="ref-code"></span></p>
        </div>
    </div>

    <div class="processing-overlay" id="receipt-modal">
        <div class="receipt-container" id="receipt-payload"></div>
    </div>

    <div class="redirect-box" id="redirect-ui">
        <div class="loader" style="border-left-color: var(--brand-red);"></div>
        <h2 style="margin-bottom: 5px;">Securely Returning...</h2>
        <p style="color: #64748b; font-size: 14px;">Your transaction session is closing.</p>
        <p style="font-weight: 800; color: var(--brand-red); margin-top: 20px;">REDIRECTING IN <span id="r-timer">7</span> SECONDS</p>
        <p style="font-size: 11px; color: #94a3b8; max-width: 300px; margin-top: 15px;">Please do not refresh. Your digital receipt has been encrypted and stored in your profile.</p>
    </div>

    <header class="navbar">
        <div style="display: flex; align-items: center; gap: 12px;">
            <img src="tanggo.png" alt="TANGGO HERVAX" style="height: 50px; width: auto; object-fit: contain;">
            <span style="font-weight: 800; letter-spacing: -0.5px; font-size: 18px;">TANGGO HERVAX</span>
        </div>
        <div style="font-size: 11px; font-weight: 700; color: var(--success-green); display: flex; align-items: center; gap: 6px;">
            <i class="fas fa-shield-check"></i> PCI-DSS COMPLIANT
        </div>
    </header>

    <div class="gateway-wrapper">
        <div class="payment-main" id="main-container">
            
            <div id="menu-screen" class="payment-screen active-screen">
                <h2 style="margin:0;">Select Payment Method</h2>
                <p style="font-size: 14px; color: #64748b; margin-top: 8px;">All transactions are encrypted and secure.</p>
                
                <div class="method-grid">
                    <div class="method-btn" onclick="showScreen('card-screen'); applyFee()">
                        <i class="fas fa-credit-card"></i>
                        <span>Card</span>
                    </div>
                    <div class="method-btn" onclick="showScreen('fpx-screen'); resetTotals()">
                        <img src="fpx.png" alt="FPX">
                        <span>Banking</span>
                    </div>
                    <div class="method-btn" onclick="showScreen('paylater-screen'); applyFee()">
                        <i class="fas fa-calendar-alt"></i>
                        <span>PayLater</span>
                    </div>
                    <div class="method-btn" onclick="handleApplePay()">
                        <img src="applepay.png" alt="Apple Pay">
                        <span>Apple Pay</span>
                    </div>
                    <div class="method-btn undpay-btn" style="border-color: #0052ff1a;" onclick="handleUNDPaySelection('UNDPAY')">
                        <div class="preferred-tag">PREFERRED</div>
                        <img src="undpay.png" alt="UNDPay">
                        <span style="color: var(--undpay-blue);">UNDPay Premium <span class="discount-badge">-4%</span></span>
                    </div>
                    <div class="method-btn undpay-btn" style="border-color: #0052ff1a;" onclick="handleUNDPaySelection('UNDPAYLATER')">
                        <div class="preferred-tag">PREFERRED</div>
                        <img src="undpaylater.png" alt="UNDPayLater">
                        <span style="color: var(--undpay-blue);">UNDPayLater</span>
                    </div>
                </div>
                
                <div style="margin-top: 40px; padding: 20px; background: #f8fafc; border-radius: 12px; display: flex; align-items: center; gap: 15px;">
                    <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                    <p style="font-size: 12px; margin: 0; color: #475569;">You will be redirected to a secure verification page after clicking continue.</p>
                </div>
            </div>

            <div id="card-screen" class="payment-screen">
                <div class="back-btn" onclick="showScreen('menu-screen'); resetTotals();"><i class="fas fa-arrow-left"></i> Change Method</div>
                <div class="card-preview">
                    <div class="card-logo" id="card-type-logo">VISA</div>
                    <div style="font-size: 1.4rem; letter-spacing: 3px; font-family: monospace;" id="card-num-live">•••• •••• •••• ••••</div>
                    <div style="display:flex; justify-content:space-between; align-items: flex-end;">
                        <div style="font-size:10px; text-transform: uppercase; opacity: 0.8;">Holder<br><span id="card-name-live" style="font-size:13px; font-weight: 600; opacity: 1;">---</span></div>
                        <div style="font-size:10px; text-transform: uppercase; opacity: 0.8; text-align: right;">Expires<br><span id="card-exp-live" style="font-size:13px; font-weight: 600; opacity: 1;">MM/YY</span></div>
                    </div>
                </div>
                <form id="card-form" oninput="checkCardForm()">
                    <div class="input-group"><label>Full Name on Card</label><input type="text" id="c-name" required oninput="this.value = this.value.toUpperCase().replace(/[^A-Z\s]/g, ''); updateCardUI()"></div>
                    <div class="input-group"><label>Card Number</label><input type="text" maxlength="19" id="c-num" required oninput="formatCard(this); updateCardUI()" placeholder="0000 0000 0000 0000"></div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="input-group"><label>Expiration Date</label><input type="text" id="c-exp" maxlength="5" required placeholder="MM/YY" oninput="formatExpiry(this); updateCardUI()"></div>
                        <div class="input-group"><label>CVV / CVC</label><input type="password" maxlength="3" id="c-cvv" required placeholder="•••" oninput="this.value = this.value.replace(/\D/g, '')"></div>
                    </div>
                    <button type="button" id="card-continue" class="btn-pay" disabled onclick="openConfirm('CARD')">Continue to Secure Pay</button>
                </form>
            </div>

            <div id="fpx-screen" class="payment-screen">
                <div class="back-btn" onclick="showScreen('menu-screen'); resetTotals();"><i class="fas fa-arrow-left"></i> Change Method</div>
                <h3>Choose Your Bank</h3>
                <div class="bank-partner-logo">OFFICIAL FPX PARTNER</div>
                
                <div class="bank-list" id="bank-list-ui">
                    <div class="bank-item" onclick="selectBank('Maybank2u', this)">
                        <span>Maybank2u</span>
                        <img src="maybank.png" alt="Maybank">
                    </div>
                    <div class="bank-item" onclick="selectBank('CIMB Clicks', this)">
                        <span>CIMB Clicks</span>
                        <img src="cimb.png" alt="CIMB">
                    </div>
                    <div class="bank-item" onclick="selectBank('Public Bank', this)">
                        <span>Public Bank</span>
                        <img src="publicbank.png" alt="Public Bank">
                    </div>
                    <div class="bank-item extra-bank hidden-bank" onclick="selectBank('RHB Now', this)">
                        <span>RHB Now</span>
                        <img src="rhb.png" alt="RHB">
                    </div>
                    <div class="bank-item extra-bank hidden-bank" onclick="selectBank('Bank Islam', this)">
                        <span>Bank Islam</span>
                        <img src="bankislam.png" alt="Bank Islam">
                    </div>
                </div>

                <button id="see-more-btn" style="background:none; border:none; color:var(--brand-red); font-weight:700; font-size:12px; cursor:pointer; margin-bottom:20px;" onclick="toggleBanks()">SEE MORE BANKS <i class="fas fa-chevron-down"></i></button>

                <button id="bank-continue-btn" class="btn-pay" disabled onclick="showScreen('fpx-login-screen')">Proceed to Bank Login</button>
            </div>

            <div id="fpx-login-screen" class="payment-screen">
                <div class="back-btn" onclick="showScreen('fpx-screen')"><i class="fas fa-arrow-left"></i> Back to Banks</div>
                <h3 id="fpx-bank-label">Bank Login</h3>
                <form oninput="checkFPXForm()">
                    <div class="input-group"><label>Online Banking Username</label><input type="text" id="fpx-u" placeholder="Your ID"></div>
                    <div class="input-group"><label>Password</label><input type="password" id="fpx-p" placeholder="••••••••"></div>
                    <button id="fpx-continue" class="btn-pay" disabled type="button" onclick="openConfirm('FPX')">Authorize Secure Login</button>
                </form>
            </div>

            <div id="paylater-screen" class="payment-screen">
                <div class="back-btn" onclick="showScreen('menu-screen'); resetTotals();"><i class="fas fa-arrow-left"></i> Change Method</div>
                <h3>Installment Application</h3>
                <form oninput="checkPLForm()">
                    <div class="input-group"><label>Legal Full Name</label><input type="text" id="pl-name" oninput="this.value = this.value.toUpperCase()"></div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="input-group"><label>Email Address</label><input type="text" id="pl-email" placeholder="email@example.com" onblur="handleEmail(this)"></div>
                        <div class="input-group"><label>Mobile Number</label><input type="text" id="pl-phone" value="+60" maxlength="12" oninput="handlePhone(this)"></div>
                    </div>
                    <div class="input-group"><label>NRIC Number</label><input type="text" id="pl-ic" placeholder="000000-00-0000" oninput="formatIC(this)"></div>
                    <p style="font-size: 12px; font-weight: 700; color: #475569; margin: 20px 0 10px;">Select Installment Plan:</p>
                    <div id="paylater-plans"></div>
                    <label style="font-size:12px; display:flex; gap:10px; align-items:center; margin: 25px 0; cursor: pointer; color: #64748b;">
                        <input type="checkbox" id="legal-check" style="width: auto;"> I confirm the information provided is accurate.
                    </label>
                    <button type="button" id="pl-continue" class="btn-pay" disabled onclick="openConfirm('PAYLATER')">Verify Credit Limit</button>
                </form>
            </div>

            <div id="undpay-screen" class="payment-screen">
                <div class="back-btn" onclick="showScreen('menu-screen'); resetTotals();"><i class="fas fa-arrow-left"></i> Change Method</div>
                <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 id="und-vault-title">UNDPay Vault Login</h3>
                    <span class="undpay-badge"><i class="fas fa-shield-alt"></i> MILITARY GRADE</span>
                </div>
                
                <div style="background: #f0f7ff; padding: 15px; border-radius: 12px; margin-bottom: 25px; border-left: 4px solid var(--undpay-blue);">
                    <p style="margin:0; font-size: 11px; color: #1e40af; line-height: 1.5;">
                        <strong>High-Security Mode:</strong> You are accessing the UNDPay Decentralized Gateway. Identity verification requires a registered Vault ID.
                    </p>
                </div>

                <form oninput="checkUNDForm()">
                    <div class="input-group">
                        <label>UND-ID (Vault Identity)</label>
                        <div style="position:relative;">
                            <input type="text" id="und-u" class="undpay-focus" placeholder="UND-VX XXX-XX-XXXX" style="padding-left: 40px;" oninput="formatUNDID(this)">
                            <i class="fas fa-user-shield" style="position:absolute; left: 15px; top: 15px; color: var(--undpay-blue);"></i>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Vault Key (Password)</label>
                        <div style="position:relative;">
                            <input type="password" id="und-p" class="undpay-focus" placeholder="••••••••" style="padding-left: 40px;">
                            <i class="fas fa-key" style="position:absolute; left: 15px; top: 15px; color: var(--undpay-blue);"></i>
                        </div>
                    </div>

                    <div id="und-pl-plan-area" style="display: none;">
                         <p style="font-size: 11px; font-weight: 700; color: var(--undpay-blue); margin: 15px 0 10px;">Select Vault Installment Plan:</p>
                         <div id="und-paylater-plans"></div>
                    </div>

                    <div style="background: #fff; border: 1.5px dashed #cbd5e1; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px; position: relative; overflow: hidden;" id="biometric-area">
                        <div class="scan-line" id="und-scanner"></div>
                        <i class="fas fa-fingerprint" style="font-size: 30px; color: #cbd5e1; margin-bottom: 10px;"></i>
                        <p style="font-size: 10px; color: #64748b; margin:0;">Biometric Lock Active<br>Waiting for credential match...</p>
                    </div>

                    <p id="scan-status-text"></p>
                    
                    <button id="und-continue" class="btn-pay btn-undpay" disabled type="button" onclick="handleUNDVaultProceed()">ACCESS SECURE VAULT</button>
                    
                    <p style="font-size: 10px; color: #94a3b8; text-align: center; margin-top: 15px;">
                        <i class="fas fa-info-circle"></i> UNDPay uses zero-knowledge proofing to hide your sensitive data from the merchant.
                    </p>
                </form>
            </div>

            <div id="success-screen" class="payment-screen">
                <div class="success-circle"><i class="fas fa-check"></i></div>
                <h2 style="text-align:center; margin-top:0;">Payment Success</h2>
                <div id="success-details-box" style="margin: 20px 0;"></div>
                <div style="font-size:12px; line-height:1.6; color:#475569; padding: 15px; background:#f8fafc; border-radius:10px;">
                    <p><strong>Note:</strong> Your official transaction receipt has been generated and filed.</p>
                    <p style="color:var(--brand-red); font-weight:700;"><strong>Reminder:</strong> Please keep a screenshot for your records if necessary.</p>
                    <p style="text-align:center; font-weight:700; margin-top:15px;">Thank you for using Tanggo Hervax Merchant Gateway.</p>
                </div>
            </div>
        </div>

        <aside class="order-sidebar">
            <p style="font-size: 11px; font-weight: 700; color: #94a3b8; letter-spacing: 1px; text-transform: uppercase;">Payment Summary</p>
            <div class="price-tag" id="summary-total">RM 0.00</div>
            
            <div style="margin-top: 25px; border-top: 1px solid #f1f5f9; padding-top: 20px;">
                <div style="display: none; justify-content: space-between; font-size: 13px; margin-bottom: 10px;" id="discount-row">
                    <span style="color: #15803d; font-weight: 700;">UNDPay Discount (4%):</span>
                    <span id="discount-val" style="color: #15803d; font-weight: 700;">- RM 0.00</span>
                </div>
                <div style="display: none; justify-content: space-between; font-size: 13px; margin-bottom: 10px;" id="fee-row">
                    <span style="color: #64748b;">Processing Fee:</span>
                    <span style="font-weight: 600;">RM 6.79</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 10px;">
                    <span style="color: #64748b;">Order Ref:</span>
                    <span id="summary-id" style="font-weight: 600;">#---</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 10px;">
                    <span style="color: #64748b;">Merchant:</span>
                    <span style="font-weight: 600;">TANGGO HERVAX</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 13px;">
                    <span style="color: #64748b;">Date:</span>
                    <span id="summary-date" style="font-weight: 600;">--/--/--</span>
                </div>
            </div>

            <div style="margin-top: 50px; text-align: center; opacity: 0.5;">
                <p style="font-size: 10px; color: #94a3b8; margin-bottom: 15px;">SECURED BY RAIZZ TECHNOLOGY</p>
                <div style="display: flex; justify-content: center; gap: 15px;">
                    <i class="fab fa-cc-visa fa-lg"></i>
                    <i class="fab fa-cc-mastercard fa-lg"></i>
                    <i class="fas fa-lock fa-lg"></i>
                </div>
            </div>
        </aside>
    </div>

    <footer>
        &copy; 2026 TANGGO HERVAX GATEWAY. All Rights Reserved. Powered by Raizz Technology Systems.
    </footer>

    <script>
        const MASTER_KEY = "bmth_master_v8";
        const checkoutData = JSON.parse(localStorage.getItem('pendingOrder')) || {
            total: "0.00", orderID: "THX-" + Math.floor(Math.random()*999999), customer: "Guest User", summary: "No items listed"
        };

        let currentTotal = parseFloat(checkoutData.total);
        let baseTotal = parseFloat(checkoutData.total);
        const TX_FEE = 6.79;
        let currentMethod = "";
        let selectedPL = false;
        let selectedPL_Months = 0;
        let selectedBankName = "";

        function moveToNext(el, index) {
            if (el.value.length >= 1) {
                el.value = el.value.slice(0, 1);
                const next = document.querySelectorAll('.otp-box')[index + 1];
                if (next) next.focus();
            }
        }

        function moveBack(event, index) {
            if (event.key === "Backspace" && !event.target.value) {
                const prev = document.querySelectorAll('.otp-box')[index - 1];
                if (prev) prev.focus();
            }
        }

        function init() {
            document.getElementById('summary-total').innerText = "RM " + currentTotal.toFixed(2);
            document.getElementById('summary-id').innerText = "#" + checkoutData.orderID;
            document.getElementById('summary-date').innerText = new Date().toLocaleDateString();
            document.getElementById('pl-name').value = (checkoutData.customer || "").toUpperCase();
            generatePayLater();
        }

        function showScreen(id) {
            document.querySelectorAll('.payment-screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(id).classList.add('active-screen');
            if(id === 'fpx-login-screen') document.getElementById('fpx-bank-label').innerText = selectedBankName + " Secure Login";
        }

        function handleApplePay() {
            currentMethod = "APPLEPAY";
            currentTotal = baseTotal + TX_FEE;
            document.getElementById('summary-total').innerText = "RM " + currentTotal.toFixed(2);
            document.getElementById('fee-row').style.display = 'flex';
            
            const loader = document.getElementById('loader');
            loader.style.display = 'flex';
            document.getElementById('loader-text').innerText = "AUTHENTICATING APPLE PAY...";
            setTimeout(() => {
                document.getElementById('loader-text').innerText = "BIOMETRIC VERIFIED...";
                setTimeout(() => { proceedToVerify(); }, 1500);
            }, 1500);
        }

        function handleUNDPaySelection(type) {
            currentMethod = type;
            resetTotals();
            
            if (type === 'UNDPAY') {
                const discount = baseTotal * 0.04;
                currentTotal = baseTotal - discount;
                document.getElementById('discount-row').style.display = 'flex';
                document.getElementById('discount-val').innerText = "- RM " + discount.toFixed(2);
                document.getElementById('und-popup-1').style.display = 'flex';
            } else {
                currentTotal = baseTotal;
                document.getElementById('und-popup-1').style.display = 'flex';
            }
            document.getElementById('summary-total').innerText = "RM " + currentTotal.toFixed(2);
        }

        function handleUNDSecurityFlow() {
            if (currentMethod === 'UNDPAY') {
                document.getElementById('und-popup-3').style.display = 'flex';
            } else {
                proceedToUNDMethod();
            }
        }

        function proceedToUNDMethod() {
            if(currentMethod === "UNDPAYLATER") {
                document.getElementById('und-vault-title').innerText = "UNDPayLater Vault";
                document.getElementById('und-pl-plan-area').style.display = 'none'; // Hidden until credit scan
                document.getElementById('und-continue').innerText = "ACCESS SECURE VAULT";
                document.getElementById('und-continue').onclick = handleUNDVaultProceed;
            } else {
                document.getElementById('und-vault-title').innerText = "UNDPay Vault Login";
                document.getElementById('und-pl-plan-area').style.display = 'none';
                document.getElementById('und-continue').innerText = "ACCESS SECURE VAULT";
                document.getElementById('und-continue').onclick = () => openConfirm('UNDPAY');
            }
            showScreen('undpay-screen');
        }

        function handleUNDVaultProceed() {
            const btn = document.getElementById('und-continue');
            const scanner = document.getElementById('und-scanner');
            const statusText = document.getElementById('scan-status-text');
            
            btn.disabled = true;
            scanner.style.display = 'block';
            statusText.style.display = 'block';
            statusText.innerText = "Analyzing Vault Liquidity...";

            setTimeout(() => { statusText.innerText = "Verifying Asset Collateral..."; }, 1200);

            setTimeout(() => {
                scanner.style.display = 'none';
                statusText.innerText = "Vault Approved: RM 15,000.00 Limit";
                statusText.style.color = 'var(--success-green)';
                
                document.getElementById('und-pl-plan-area').style.display = 'block';
                generateUNDPayLater();
                btn.disabled = true; // Wait for plan selection
                btn.innerText = "CONFIRM VAULT REPAYMENT";
                btn.onclick = () => openConfirm('UNDPAYLATER');
            }, 2500);
        }

        function resetTotals() {
            currentTotal = baseTotal;
            selectedPL = false;
            document.getElementById('summary-total').innerText = "RM " + baseTotal.toFixed(2);
            document.getElementById('discount-row').style.display = 'none';
            document.getElementById('fee-row').style.display = 'none';
        }

        function applyFee() {
            resetTotals();
            currentTotal = baseTotal + TX_FEE;
            document.getElementById('summary-total').innerText = "RM " + currentTotal.toFixed(2);
            document.getElementById('fee-row').style.display = 'flex';
        }

        function formatUNDID(el) {
            let value = el.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            if (!value.startsWith("UNDVX")) { value = "UNDVX" + value; }
            let formatted = "UND-VX ";
            let core = value.substring(5); 
            if (core.length > 0) { formatted += core.substring(0, 3); }
            if (core.length > 3) { formatted += "-" + core.substring(3, 5); }
            if (core.length > 5) { formatted += "-" + core.substring(5, 9); }
            el.value = formatted;
        }

        function selectBank(name, el) {
            document.querySelectorAll('.bank-item').forEach(b => b.classList.remove('bank-selected'));
            el.classList.add('bank-selected');
            selectedBankName = name;
            document.getElementById('bank-continue-btn').disabled = false;
        }

        function toggleBanks() {
            const extra = document.querySelectorAll('.extra-bank');
            const btn = document.getElementById('see-more-btn');
            const isHidden = extra[0].classList.contains('hidden-bank');
            extra.forEach(eb => eb.classList.toggle('hidden-bank'));
            btn.innerHTML = isHidden ? 'SHOW LESS <i class="fas fa-chevron-up"></i>' : 'SEE MORE BANKS <i class="fas fa-chevron-down"></i>';
        }

        function triggerError(msg) { 
            document.getElementById('alert-msg').innerText = msg; 
            document.getElementById('alert-system').style.display = 'flex'; 
        }

        function handlePhone(input) { if (!input.value.startsWith('+60')) input.value = '+60'; let digits = input.value.substring(3).replace(/\D/g, ''); input.value = '+60' + digits.substring(0, 9); }
        function handleEmail(input) { if (input.value && !input.value.includes('@')) input.value = input.value.trim().toLowerCase() + "@gmail.com"; }
        function formatCard(el) { el.value = el.value.replace(/\D/g, '').match(/.{1,4}/g)?.join(' ') || ''; }
        function formatExpiry(el) { let v = el.value.replace(/\D/g, ''); el.value = v.length > 2 ? v.slice(0, 2) + '/' + v.slice(2, 4) : v; }
        function formatIC(el) { let v = el.value.replace(/\D/g, ''); let out = ""; if(v.length > 0) out += v.slice(0,6); if(v.length > 6) out += '-' + v.slice(6,8); if(v.length > 8) out += '-' + v.slice(8,12); el.value = out; }
        
        function updateCardUI() { 
            document.getElementById('card-num-live').innerText = document.getElementById('c-num').value || "•••• •••• •••• ••••"; 
            document.getElementById('card-name-live').innerText = document.getElementById('c-name').value || "CARDHOLDER NAME"; 
            document.getElementById('card-exp-live').innerText = document.getElementById('c-exp').value || "MM/YY"; 
            const num = document.getElementById('c-num').value; 
            document.getElementById('card-type-logo').innerText = num.startsWith('4') ? "VISA" : num.startsWith('5') ? "MASTERCARD" : "SECURE CARD"; 
        }

        function checkCardForm() { const isValid = document.getElementById('c-num').value.length === 19 && document.getElementById('c-name').value.length > 3 && document.getElementById('c-exp').value.length === 5 && document.getElementById('c-cvv').value.length === 3; document.getElementById('card-continue').disabled = !isValid; }
        function checkFPXForm() { const isValid = document.getElementById('fpx-u').value.length > 2 && document.getElementById('fpx-p').value.length > 2; document.getElementById('fpx-continue').disabled = !isValid; }
        function checkPLForm() { const isValid = document.getElementById('pl-ic').value.length === 14 && document.getElementById('pl-email').value.includes('@') && document.getElementById('pl-phone').value.length >= 11 && document.getElementById('legal-check').checked && selectedPL; document.getElementById('pl-continue').disabled = !isValid; }
        function checkUNDForm() { 
            const isValid = document.getElementById('und-u').value.length >= 17 && document.getElementById('und-p').value.length > 4; 
            document.getElementById('und-continue').disabled = !isValid; 
            if(isValid) {
                document.getElementById('und-scanner').style.display = 'block';
                document.querySelector('#biometric-area i').style.color = 'var(--undpay-blue)';
            } else {
                document.getElementById('und-scanner').style.display = 'none';
                document.querySelector('#biometric-area i').style.color = '#cbd5e1';
            }
        }
        
        function generatePayLater() { 
            const months = [3, 6, 12]; 
            document.getElementById('paylater-plans').innerHTML = months.map(m => { 
                const total = (baseTotal + TX_FEE) * (1 + (0.01 * m)); 
                return `<div class="installment-box" onclick="setPL(${total}, ${m}, this)"><span>${m} Months Plan</span><strong>RM ${(total/m).toFixed(2)}/mo</strong></div>`; 
            }).join(''); 
        }

        function generateUNDPayLater() {
            const months = [3, 6, 12]; 
            document.getElementById('und-paylater-plans').innerHTML = months.map(m => { 
                const total = baseTotal * (1 + (0.005 * m)); 
                return `<div class="installment-box" style="border-color:#0052ff2a; align-items:center;" onclick="setUNDPL(${total}, ${m}, this)">
                    <div><span style="font-weight:700;">${m} Months (VIP)</span> <span class="asset-backed-badge">ASSET-BACKED</span></div>
                    <strong>RM ${(total/m).toFixed(2)}/mo</strong>
                </div>`; 
            }).join(''); 
        }

        function renderRoadmap(months, amount) {
            let roadmapHtml = `<div class="roadmap-container"><p style="font-size:10px; font-weight:800; margin:0 0 10px 0; color:#64748b;">REPAYMENT ROADMAP</p>`;
            for(let i=1; i<=3; i++) {
                const date = new Date(); date.setMonth(date.getMonth() + i);
                roadmapHtml += `<div class="roadmap-step"><div class="roadmap-dot"></div><div class="roadmap-info"><span class="roadmap-date">Month ${i}: ${date.toLocaleDateString('en-MY', {month:'short', year:'numeric'})}</span><span class="roadmap-amt">RM ${amount}</span></div></div>`;
            }
            if(months > 3) roadmapHtml += `<p style="font-size:9px; color:#94a3b8; margin:5px 0 0 22px;">+ ${months-3} more installments</p>`;
            roadmapHtml += `</div>`;
            
            let existing = document.getElementById('und-roadmap');
            if(!existing) { existing = document.createElement('div'); existing.id = 'und-roadmap'; document.getElementById('und-paylater-plans').after(existing); }
            existing.innerHTML = roadmapHtml;
        }
        
        function setPL(amt, months, el) { 
            document.querySelectorAll('.installment-box').forEach(b => b.classList.remove('inst-active')); 
            el.classList.add('inst-active'); 
            currentTotal = amt; selectedPL_Months = months; selectedPL = true; 
            document.getElementById('summary-total').innerText = "RM " + amt.toFixed(2); 
            checkPLForm(); 
        }

        function setUNDPL(amt, months, el) {
            document.querySelectorAll('.installment-box').forEach(b => b.classList.remove('inst-active')); 
            el.classList.add('inst-active'); 
            currentTotal = amt; selectedPL_Months = months; selectedPL = true; 
            document.getElementById('summary-total').innerText = "RM " + amt.toFixed(2); 
            renderRoadmap(months, (amt/months).toFixed(2));
            document.getElementById('und-continue').disabled = false;
        }

        function openConfirm(method) {
            currentMethod = method;
            let detailHTML = `<p><strong>Merchant:</strong> TANGGO HERVAX</p><p><strong>Order ID:</strong> #${checkoutData.orderID}</p><hr style="border:0; border-top:1px solid #e2e8f0; margin:10px 0;">`;
            if(method === 'CARD') { detailHTML += `<p><strong>Method:</strong> Credit/Debit Card</p><p><strong>Account:</strong> •••• ${document.getElementById('c-num').value.slice(-4)}</p><p><strong>Fee:</strong> RM 6.79</p>`; } 
            else if(method === 'PAYLATER') { detailHTML += `<p><strong>Method:</strong> PayLater</p><p><strong>Tenure:</strong> ${selectedPL_Months} Months</p><p><strong>Fee:</strong> RM 6.79</p>`; } 
            else if(method === 'UNDPAY' || method === 'UNDPAYLATER') { 
                detailHTML += `<p><strong>Method:</strong> ${method === 'UNDPAY' ? 'UNDPay Premium' : 'UNDPayLater'}</p><p><strong>Vault ID:</strong> ${document.getElementById('und-u').value}</p>`; 
                if(method === 'UNDPAY') detailHTML += `<p style="color:#15803d;"><strong>Discount Applied:</strong> 4%</p>`;
                if(method === 'UNDPAYLATER') detailHTML += `<p><strong>Tenure:</strong> ${selectedPL_Months} Months</p>`;
            }
            else if(method === 'APPLEPAY') { detailHTML += `<p><strong>Method:</strong> Apple Pay</p><p><strong>Device:</strong> Verified via iOS/macOS</p><p><strong>Fee:</strong> RM 6.79</p>`; }
            else { detailHTML += `<p><strong>Method:</strong> Online Banking (FPX)</p><p><strong>Bank:</strong> ${selectedBankName}</p>`; }
            document.getElementById('dynamic-details-area').innerHTML = detailHTML;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function checkAgreementRequirement() {
            closePopup('confirm-modal');
            if(currentMethod === 'PAYLATER' || currentMethod === 'UNDPAYLATER') document.getElementById('agreement-modal').style.display = 'flex';
            else startMultiStepProcess();
        }

        function startMultiStepProcess() {
            closePopup('agreement-modal');
            const loader = document.getElementById('loader');
            const lText = document.getElementById('loader-text');
            loader.style.display = 'flex';
            
            if(currentMethod.startsWith('UND')) {
                lText.innerText = "INITIALIZING BIOMETRIC HANDSHAKE...";
                setTimeout(() => {
                    lText.innerText = "SYNCING WITH UND-CLOUD VAULT...";
                    setTimeout(() => {
                        lText.innerText = "DECRYPTING PRIVATE RSA KEYS...";
                        setTimeout(() => {
                            lText.innerText = "GENERATING HARDWARE TOKEN...";
                            setTimeout(() => { proceedToVerify(); }, 2000);
                        }, 1500);
                    }, 1500);
                }, 1500);
            } else {
                lText.innerText = "ENCRYPTING TRANSACTION...";
                setTimeout(() => { 
                    lText.innerText = "HANDSHAKE VERIFIED..."; 
                    setTimeout(() => { proceedToVerify(); }, 1500); 
                }, 1500);
            }
        }

        function proceedToVerify() {
            document.getElementById('loader').style.display = 'none'; 
            document.getElementById('verification-modal').style.display = 'flex'; 
            document.getElementById('ref-code').innerText = Math.random().toString(36).substring(2,8).toUpperCase();
            
            if(currentMethod.startsWith('UND')) {
                document.getElementById('verification-title').innerText = "Hardware Token Verification";
                document.getElementById('verification-desc').innerHTML = "Enter the high-security token from your <strong>UNDPay Authenticator App</strong>.";
                document.getElementById('final-auth-btn').style.background = 'var(--undpay-blue)';
            } else {
                document.getElementById('verification-title').innerText = "3D Secure Verification";
                document.getElementById('verification-desc').innerText = "Enter the 6-digit code sent to your phone.";
                document.getElementById('final-auth-btn').style.background = 'var(--brand-dark)';
            }
            document.querySelector('.otp-box').focus();
        }

        function finalAuthorize() {
            let code = "";
            document.querySelectorAll('#otp-inputs input').forEach(input => code += input.value);
            if(code.length < 6) { 
                triggerError("Transaction Failed: Please enter the valid 6-digit code sent to your device."); 
                return; 
            }
            
            const recentOrder = {
                id: checkoutData.orderID,
                date: new Date().toLocaleDateString(),
                status: "Processing",
                items: checkoutData.summary,
                total: currentTotal.toFixed(2),
                type: (checkoutData.summary.toLowerCase().includes("ticket")) ? 'ticket' : 'merch'
            };
            localStorage.setItem('bmth_recent_order', JSON.stringify(recentOrder));

            closePopup('verification-modal');
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('loader-text').innerText = "PROCESSING AUTHORIZATION...";
            setTimeout(() => { 
                document.getElementById('loader-text').innerText = "GENERATING E-INVOICE..."; 
                setTimeout(() => { generateFinalReceipt(); }, 2000); 
            }, 2000);
        }

        function generateFinalReceipt() {
            document.getElementById('loader').style.display = 'none';
            const transID = "TXN-" + Math.floor(Math.random()*900000 + 100000);
            const invID = "INV/2026/TX" + Math.floor(Math.random()*9999);
            
            let customerName = checkoutData.customer.toUpperCase();
            if(currentMethod === 'PAYLATER') customerName = document.getElementById('pl-name').value;
            if(currentMethod.startsWith('UND')) customerName = document.getElementById('und-u').value;
            
            let methodLabel = "";
            if(currentMethod === 'CARD') methodLabel = "Credit/Debit Card";
            else if(currentMethod === 'PAYLATER') methodLabel = "PayLater Installment";
            else if(currentMethod === 'UNDPAY') methodLabel = "UNDPay Vault (Deep Encrypted)";
            else if(currentMethod === 'UNDPAYLATER') methodLabel = "UNDPayLater Installment";
            else if(currentMethod === 'APPLEPAY') methodLabel = "Apple Pay (iOS)";
            else methodLabel = "FPX Online Banking (" + selectedBankName + ")";

            let scheduleHTML = "";
            if(currentMethod === 'PAYLATER' || currentMethod === 'UNDPAYLATER') {
                const monthlyAmt = (currentTotal/selectedPL_Months).toFixed(2);
                scheduleHTML = `<div style="margin-top:20px; border:1px solid #e2e8f0; border-radius:8px; overflow:hidden;"><div style="background:#f8fafc; padding:8px 15px; font-size:11px; font-weight:bold; border-bottom:1px solid #e2e8f0; color:#475569;">REPAYMENT SCHEDULE</div><div style="padding:10px 15px;">`;
                let today = new Date();
                let nextMonth = today.getMonth() + 1;
                let year = today.getFullYear();
                for(let i=1; i<=selectedPL_Months; i++) {
                    let displayMonth = (nextMonth + (i-1)) % 12;
                    let displayYear = year + Math.floor((nextMonth + (i-1)) / 12);
                    if(displayMonth === 0) { displayMonth = 12; displayYear -= 1; }
                    let dateStr = "01/" + (displayMonth < 10 ? '0' + displayMonth : displayMonth) + "/" + displayYear;
                    scheduleHTML += `<div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:4px;"><span style="color:#64748b;">${dateStr} Repayment</span><span style="font-weight:600; color:#0f172a;">RM ${monthlyAmt}</span></div>`;
                }
                scheduleHTML += `</div></div>`;
            }

            const receiptHeaderColor = (currentMethod.startsWith('UND')) ? 'var(--undpay-blue)' : '#0f172a';
            const hasFee = (currentMethod === 'CARD' || currentMethod === 'PAYLATER' || currentMethod === 'APPLEPAY');

            document.getElementById('receipt-payload').innerHTML = `
                <div style="background:${receiptHeaderColor}; padding:20px; color:white; display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:10px;"><img src="tanggo.png" style="height:45px; filter:brightness(0) invert(1);"><div><div style="font-weight:900; font-size:18px;">E-INVOICE</div><div style="font-size:10px; opacity:0.7;">Official Record</div></div></div>
                    <div style="text-align:right;"><div style="font-weight:bold; font-size:12px;">TANGGO HERVAX</div><div style="font-size:9px; opacity:0.7;">Merchant ID: THX-99281</div></div>
                </div>
                <div style="padding:30px; text-align:left;">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:25px; border-bottom: 1px solid #f1f5f9; padding-bottom:20px;">
                        <div><div style="font-size:9px; color:#94a3b8; font-weight:800;">Customer Identity</div><div style="font-size:12px; font-weight:700;">${customerName}</div></div>
                        <div style="text-align:right;"><div style="font-size:9px; color:#94a3b8; font-weight:800;">Details</div><div style="font-size:11px;">ID: ${invID}</div><div style="font-size:11px;">Date: ${new Date().toLocaleDateString()}</div></div>
                    </div>
                    <div style="margin-bottom:20px;">
                        <div style="display:flex; justify-content:space-between; font-size:10px; color:#94a3b8; border-bottom:1.5px solid #0f172a; padding-bottom:8px; margin-bottom:12px;"><span>DESCRIPTION</span><span>TOTAL</span></div>
                        <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:10px;"><span style="font-weight:600;">${checkoutData.summary || 'Merchandise'}</span><span style="font-weight:700;">RM ${baseTotal.toFixed(2)}</span></div>
                        ${hasFee ? `<div style="display:flex; justify-content:space-between; font-size:11px; color:#64748b; margin-bottom:10px;"><span>Processing Fee</span><span>RM 6.79</span></div>` : ''}
                        ${(currentMethod === 'PAYLATER' || currentMethod === 'UNDPAYLATER') ? `<div style="display:flex; justify-content:space-between; font-size:11px; color:#64748b; margin-bottom:10px;"><span>Installment Interest</span><span>RM ${(currentTotal - (currentMethod === 'UNDPAYLATER' ? baseTotal : (baseTotal + TX_FEE))).toFixed(2)}</span></div>` : ''}
                        ${currentMethod === 'UNDPAY' ? `<div style="display:flex; justify-content:space-between; font-size:11px; color:#15803d; margin-bottom:10px;"><span>UNDPay VIP Discount (4%)</span><span>- RM ${(baseTotal * 0.04).toFixed(2)}</span></div>` : ''}
                        <div style="display:flex; justify-content:space-between; font-size:11px; color:#64748b; margin-bottom:10px;"><span>Payment Method</span><span>${methodLabel}</span></div>
                        <div style="border-top:1px solid #f1f5f9; margin-top:15px; padding-top:15px; display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:900; font-size:13px;">GRAND TOTAL</span><span style="font-weight:900; font-size:24px;">RM ${currentTotal.toFixed(2)}</span></div>
                    </div>
                    ${scheduleHTML}
                    <div style="margin-top:30px; padding:15px; border-radius:12px; background:#f0fdf4; color:#15803d; font-size:11px; font-weight:700; text-align:center;"><i class="fas fa-check-circle"></i> PAYMENT AUTHORIZED</div>
                    <div style="margin-top:25px; display:flex; gap:10px;">
                        <button class="btn-pay" style="flex:1; background:#64748b; font-size:11px;" onclick="window.print()">DOWNLOAD</button>
                        <button class="btn-pay ${currentMethod.startsWith('UND') ? 'btn-undpay' : ''}" style="flex:1; font-size:11px;" onclick="finish('${transID}', '${methodLabel}')">OKAY <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            `;
            document.getElementById('receipt-modal').style.display = 'flex';
        }

        function finish(transID, methodLabel) {
            closePopup('receipt-modal');
            const now = new Date();
            const detailsHTML = `
                <div class="success-row"><span class="success-label">Date & Time</span><span class="success-val">${now.toLocaleDateString()} | ${now.toLocaleTimeString()}</span></div>
                <div class="success-row"><span class="success-label">Amount</span><span class="success-val">RM ${currentTotal.toFixed(2)}</span></div>
                <div class="success-row"><span class="success-label">Method</span><span class="success-val">${methodLabel}</span></div>
                <div class="success-row"><span class="success-label">Purchase</span><span class="success-val">${checkoutData.summary || 'Items'}</span></div>
                <div class="success-row"><span class="success-label">Ref ID</span><span class="success-val">${transID}</span></div>
            `;
            document.getElementById('success-details-box').innerHTML = detailsHTML;
            showScreen('success-screen');

            const history = JSON.parse(localStorage.getItem('bmth_orders')) || [];
            history.unshift({ id: transID, orderRef: checkoutData.orderID, date: now.toLocaleString(), total: currentTotal.toFixed(2), method: currentMethod, items: checkoutData.summary, status: "COMPLETED" });
            localStorage.setItem('bmth_orders', JSON.stringify(history));

            const pendingCat = localStorage.getItem("pending_cat");
            if ((checkoutData.summary && checkoutData.summary.toLowerCase().includes("ticket")) || pendingCat !== null) {
                let data = JSON.parse(localStorage.getItem(MASTER_KEY)) || {};
                data.userPurchased = true; 
                data.purchasedCatId = pendingCat;
                localStorage.setItem(MASTER_KEY, JSON.stringify(data));
            }

            setTimeout(() => {
                document.getElementById('redirect-ui').style.display = 'flex';
                let timeLeft = 7;
                const countdown = setInterval(() => {
                    timeLeft--;
                    document.getElementById('r-timer').innerText = timeLeft;
                    if(timeLeft <= 0) {
                        clearInterval(countdown);
                        localStorage.removeItem('pendingOrder');
                        localStorage.removeItem('bmth_cart'); 
                        localStorage.removeItem('pending_cat'); 
                        window.location.href = 'index.html'; 
                    }
                }, 1000);
            }, 5000);
        }

        function closePopup(id) { document.getElementById(id).style.display = 'none'; }
        init();
    </script>
</body>
</html>